<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Jarvis Cinematic Engine â€“ Advanced</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://cdn.jsdelivr.net/npm/three@0.158.0/build/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>

<style>
body{margin:0;overflow:hidden;background:black}
#video{display:none}
.hud{
  position:fixed;
  top:10px;
  left:50%;
  transform:translateX(-50%);
  color:#00ffff;
  font-family:monospace;
  font-size:13px;
  opacity:.75
}
</style>
</head>

<body>
<video id="video" autoplay playsinline></video>
<div class="hud" id="hud">JARVIS ONLINE</div>

<script>
/* =========================
   BASIC SETUP
========================= */
const scene=new THREE.Scene();
const camera=new THREE.PerspectiveCamera(75,innerWidth/innerHeight,0.1,100);
camera.position.z=6;

const renderer=new THREE.WebGLRenderer({antialias:true});
renderer.setSize(innerWidth,innerHeight);
renderer.setPixelRatio(Math.min(devicePixelRatio,1.5));
document.body.appendChild(renderer.domElement);

/* =========================
   STATES
========================= */
const MODES={IDLE:0,SCAN:1};
let currentMode=MODES.IDLE;

/* =========================
   AUDIO (MIC)
========================= */
let audioLevel=0;
navigator.mediaDevices.getUserMedia({audio:true}).then(stream=>{
  const ctx=new AudioContext();
  const src=ctx.createMediaStreamSource(stream);
  const analyser=ctx.createAnalyser();
  analyser.fftSize=256;
  src.connect(analyser);
  const data=new Uint8Array(analyser.frequencyBinCount);

  function audioLoop(){
    analyser.getByteFrequencyData(data);
    let sum=0;
    for(let i=0;i<20;i++) sum+=data[i];
    audioLevel=sum/20/255;
    requestAnimationFrame(audioLoop);
  }
  audioLoop();
}).catch(()=>{ audioLevel=0; });

/* =========================
   ENERGY CORE
========================= */
const COUNT=2400;
const basePositions=new Float32Array(COUNT*3);
const positions=new Float32Array(COUNT*3);

for(let i=0;i<COUNT;i++){
  const u=Math.random();
  const v=Math.random();
  const t=2*Math.PI*u;
  const p=Math.acos(2*v-1);
  const r=1.6;
  const x=r*Math.sin(p)*Math.cos(t);
  const y=r*Math.cos(p);
  const z=r*Math.sin(p)*Math.sin(t);
  basePositions.set([x,y,z],i*3);
  positions.set([x,y,z],i*3);
}

const geo=new THREE.BufferGeometry();
geo.setAttribute("position",new THREE.BufferAttribute(positions,3));

const mat=new THREE.ShaderMaterial({
  uniforms:{
    time:{value:0},
    scan:{value:0},
    audio:{value:0},
    color:{value:new THREE.Color(0x00ffff)}
  },
  vertexShader:`
    uniform float time;
    uniform float scan;
    uniform float audio;
    varying float vGlow;
    void main(){
      float d=length(position);
      float pulse=0.7+0.3*sin(time*2.0+d*6.0);
      float wave=smoothstep(scan-0.2,scan,d)*smoothstep(scan,scan-0.4,d);
      vec3 pos=position+normalize(position)*(pulse*0.12+wave*0.6+audio*0.4);
      vGlow=pulse+wave;
      gl_Position=projectionMatrix*modelViewMatrix*vec4(pos,1.0);
      gl_PointSize=3.0;
    }
  `,
  fragmentShader:`
    uniform vec3 color;
    varying float vGlow;
    void main(){
      float g=clamp(vGlow,0.35,1.0);
      gl_FragColor=vec4(color*g,g);
    }
  `,
  transparent:true,
  blending:THREE.AdditiveBlending,
  depthWrite:false
});

const core=new THREE.Points(geo,mat);
scene.add(core);

/* =========================
   HAND TRACKING
========================= */
const video=document.getElementById("video");
const hands=new Hands({
  locateFile:f=>`https://cdn.jsdelivr.net/npm/@mediapipe/hands/${f}`
});
hands.setOptions({maxNumHands:1,minDetectionConfidence:.7,minTrackingConfidence:.7});

function isSwipe(h){
  return Math.abs(h[8].x-h[5].x)>0.3;
}

hands.onResults(r=>{
  if(!r.multiHandLandmarks?.length) return;
  const h=r.multiHandLandmarks[0];
  if(isSwipe(h)) currentMode=MODES.SCAN;
});

new Camera(video,{
  onFrame:async()=>hands.send({image:video}),
  width:640,height:480,facingMode:"user"
}).start();

/* =========================
   ANIMATION
========================= */
let scanRadius=0;
let exploding=false;

function animate(t){
  requestAnimationFrame(animate);

  mat.uniforms.time.value+=0.01;
  mat.uniforms.audio.value=audioLevel;

  if(currentMode===MODES.SCAN){
    scanRadius+=0.05;
    if(scanRadius>4){
      scanRadius=0;
      currentMode=MODES.IDLE;
    }
    mat.uniforms.scan.value=scanRadius;
  }else{
    mat.uniforms.scan.value=-10;
  }

  core.rotation.y+=0.002;
  renderer.render(scene,camera);
}
animate();

/* =========================
   RESIZE
========================= */
addEventListener("resize",()=>{
  camera.aspect=innerWidth/innerHeight;
  camera.updateProjectionMatrix();
  renderer.setSize(innerWidth,innerHeight);
});
</script>
</body>
</html>
